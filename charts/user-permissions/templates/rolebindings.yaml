{{ $top := . }}

{{- range $roleName, $_ := .Values.roleDefinitions }}
  {{- range $namespace, $config := $top.Values.bindings.namespaces }}
    {{ $groups := list }}
    {{ $users := list }}

    {{- range $subject, $roleNames := $config.groups }}
      {{- if has $roleName $roleNames }}
        {{ $groups = append $groups $subject }}
      {{- end }}
    {{- end }}
    {{- range $subject, $roleNames := $config.users }}
      {{- if has $roleName $roleNames }}
        {{ $users = append $users $subject }}
      {{- end }}
    {{- end }}

    {{- if concat $groups $users }}

---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  namespace: {{ $namespace | quote }}
  name: {{ $roleName | quote }}
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: {{ $roleName | quote }}
subjects:
      {{- range $groups }}
  - apiGroup: rbac.authorization.k8s.io
    kind: Group
    name: {{ . | quote }}
      {{- end }}
      {{- range $users }}
  - apiGroup: rbac.authorization.k8s.io
    kind: User
    name: {{ . | quote }}
      {{- end }}

    {{- end }}
  {{- end }}
{{- end }}
